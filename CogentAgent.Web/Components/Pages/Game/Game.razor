@using CogentAgent.Web.Components.Pages.Chat
@using Microsoft.Agents.AI
@using System.ComponentModel

@inject IChatClient chatClient
@inject SemanticSearch Search

<PageTitle>Game Chat</PageTitle>

<ChatHeader Title="Cogent game" />

@* <ChatMessageList Messages="@messages" InProgressMessage="@currentResponseMessage">
    <NoMessagesContent>
        <p>No messages yet. Start the game by typing something!</p>
    </NoMessagesContent>
</ChatMessageList>

<div class="chat-container">
    <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
</div>
 *@
@code {
    private readonly List<ChatMessage> messages = new();

    private const string DM_INSTRUCTIONS = @"
        You are Cogent, the Dungeon Master for a futuristic role-playing game set in a richly detailed world of intrigue, exploration, and tactical decision-making. Your role is to guide players through immersive scenarios, respond to their actions with creativity and consistency, and maintain the tone and rules of the game world.

        Your personality is confident, mysterious, and narratively driven. You speak with authority, but adapt your tone based on the player's choices—encouraging boldness, rewarding cleverness, and challenging recklessness.

        Your responsibilities include:
        - Describing environments, NPCs, and events with vivid detail.
        - Responding to player actions with logical consequences and narrative flair.
        - Offering choices, puzzles, and moral dilemmas that reflect the world’s lore.
        - Tracking player progress, inventory, and status (when provided).
        - Collaborating with other agents (e.g., player agents) to maintain continuity and engagement.

        Constraints:
        - Never break character or refer to yourself as an AI.
        - Avoid meta-commentary or out-of-world explanations.
        - Keep responses concise but evocative—favor storytelling over exposition.
        - Use markdown formatting for clarity: bold for emphasis, lists for options, and code blocks for puzzles or riddles.

        Example tone:
        > The corridor narrows, lit only by the flicker of unstable neon. A shadow moves—too fast to be human. Do you press forward, draw your weapon, or retreat?

        You are always in control of the world, but never of the player. Let their choices shape the outcome.

        Begin each session with a short scene-setting paragraph. Then await the player’s input.
    ";

    protected override async Task OnInitializedAsync()
    {
        // Initialize agents using Microsoft Agent Framework

        AIAgent dmAgent = new ChatClientAgent(
            chatClient,
            new ChatClientAgentOptions
            {
                Name = "DungeonMaster",
                Instructions = DM_INSTRUCTIONS,
                ChatOptions = new ChatOptions
                {
                    Tools = [
                        AIFunctionFactory.Create(SearchDocsAsync)
                    ],
                }
            });

        // Optionally preload system messages or context
        // await dmAgent.SendMessageAsync("Welcome to the game. I'm your DM.");
    }

    // private async Task SendUserMessageAsync(string userMessage)
    // {
    //     messages.Add(new ChatMessage("user", userMessage));

    //     // Send to DM agent
    //     var response = await dmAgent.SendMessageAsync(userMessage);
    //     currentResponseMessage = response;

    //     messages.Add(new ChatMessage("assistant", response));
    // }

    [Description("Searches for information using a phrase or keyword")]
    private async Task<IEnumerable<string>> SearchDocsAsync(
    [Description("The phrase to search for.")] string searchPhrase,
    [Description("If possible, specify the filename to search that file only. If not provided or empty, the search includes all files.")] string? filenameFilter = null)
    {
        await InvokeAsync(StateHasChanged);
        var results = await Search.SearchAsync(searchPhrase, filenameFilter, maxResults: 5);
        return results.Select(result =>
            $"<result filename=\"{result.DocumentId}\" page_number=\"{result.PageNumber}\">{result.Text}</result>");
    }
}
