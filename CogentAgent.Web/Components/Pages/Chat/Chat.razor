@page "/"

@using System.ComponentModel
@using CogentAgent.Web.Components.Pages.Game
@using CogentAgent.Web.Models

@inject IChatClient ChatClient
@inject NavigationManager Nav
@inject SemanticSearch Search

@implements IDisposable

<PageTitle>Cogent Chat</PageTitle>

<div class="chat-layout">
    <!-- Left: Player Chat -->
    <div class="chat-pane">
        <ChatHeader OnNewChat="@ResetConversationAsync" />

        <ChatMessageList Messages="@messages" InProgressMessage="@currentResponseMessage" OnPlayGameRequested="@HandlePlayGame">
            <NoMessagesContent>
            </NoMessagesContent>
        </ChatMessageList>

        <div class="chat-container">
            <ChatSuggestions OnSelected="@AddUserMessageAsync" @ref="@chatSuggestions" />
            <ChatInput OnSend="@AddUserMessageAsync" @ref="@chatInput" />
        </div>
    </div>

    <!-- Right: Game Chat (conditionally shown) -->
    <div class="chat-pane right-pane @(showRightPane ? "visible" : "hidden")">
        @if (showRightPane)
        {
            <GameChat></GameChat>
        }
    </div>
</div>

<button class="toggle-pane-button" @onclick="ToggleRightPane">
    @((showRightPane ? "Hide" : "Show") + " Game View")
</button>

@code {
    private bool showRightPane = false;
    private void ToggleRightPane() => showRightPane = !showRightPane;

    private void HandlePlayGame()
    {
        ToggleRightPane();
    }

    private int statefulMessageCount;
    private readonly ChatOptions chatOptions = new();
    private readonly List<ChatMessage> messages = new();
    private CancellationTokenSource? currentResponseCancellation;
    private ChatMessage? currentResponseMessage;
    private ChatInput? chatInput;
    private ChatSuggestions? chatSuggestions;

    protected override void OnInitialized()
    {
        statefulMessageCount = 0;
        messages.Add(new(ChatRole.System, Prompts.ADVISOR_INSTRUCTIONS));
        messages.Add(new(ChatRole.Assistant, "Ask me some question, whether it's about game, mechanics or wonderful world of fantasy."));
        chatOptions.Tools = [AIFunctionFactory.Create(SearchAsync)];
    }

    private async Task AddUserMessageAsync(ChatMessage userMessage)
    {
        CancelAnyCurrentResponse();

        // Add the user message to the conversation
        messages.Add(userMessage);
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();

        // Stream and display a new response from the IChatClient
        var responseText = new TextContent("");
        currentResponseMessage = new ChatMessage(ChatRole.Assistant, [responseText]);
        currentResponseCancellation = new();
        await foreach (var update in ChatClient.GetStreamingResponseAsync(messages.Skip(statefulMessageCount), chatOptions, currentResponseCancellation.Token))
        {
            messages.AddMessages(update, filter: c => c is not TextContent);
            responseText.Text += update.Text;
            chatOptions.ConversationId = update.ConversationId;
            ChatMessageItem.NotifyChanged(currentResponseMessage);
        }

        // Store the final response in the conversation, and begin getting suggestions
        messages.Add(currentResponseMessage!);
        statefulMessageCount = chatOptions.ConversationId is not null ? messages.Count : 0;
        currentResponseMessage = null;
        chatSuggestions?.Update(messages);
    }

    private void CancelAnyCurrentResponse()
    {
        // If a response was cancelled while streaming, include it in the conversation so it's not lost
        if (currentResponseMessage is not null)
        {
            messages.Add(currentResponseMessage);
        }

        currentResponseCancellation?.Cancel();
        currentResponseMessage = null;
    }

    private async Task ResetConversationAsync()
    {
        CancelAnyCurrentResponse();
        messages.Clear();
        messages.Add(new(ChatRole.System, Prompts.ADVISOR_INSTRUCTIONS));
        chatOptions.ConversationId = null;
        statefulMessageCount = 0;
        chatSuggestions?.Clear();
        await chatInput!.FocusAsync();
    }

    [Description("Searches for information using a phrase or keyword")]
    private async Task<IEnumerable<string>> SearchAsync(
        [Description("The phrase to search for.")] string searchPhrase,
        [Description("If possible, specify the filename to search that file only. If not provided or empty, the search includes all files.")] string? filenameFilter = null)
    {
        await InvokeAsync(StateHasChanged);
        var results = await Search.SearchAsync(searchPhrase, filenameFilter, maxResults: 5);
        return results.Select(result =>
            $"<result filename=\"{result.DocumentId}\" page_number=\"{result.PageNumber}\">{result.Text}</result>");
    }

    public void Dispose()
        => currentResponseCancellation?.Cancel();
}
